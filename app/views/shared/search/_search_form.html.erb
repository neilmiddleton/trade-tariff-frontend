<%= form_tag perform_search_path, method: :get, id: "new_search" do |f| %>
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-three-quarters">

      <%= label_tag :q, search_label_text, class: 'govuk-label', style:'order: 2' %>

        <div class="govuk-fieldset" id='autocomplete' aria-describedby='q' style='order: 3'>
          <script>
            window.onload = function() {
              let tempQuery = '';
              window.accessibleAutocomplete({
                element: document.querySelector('#autocomplete'),
                id: 'autocomplete', // To match it to the existing <label>.
                required: 'true',
                className: 'govuk-input',
                name: 'q',
                confirmOnBlur: false,
                placeholder: 'Enter the name of the goods or commodity code',
                tNoResults: () => `${tempQuery}`,
                templates: {
                  inputValue: function(result) {
                    return result;
                  },
                  suggestion: function(result) {
                    return result.replace(tempQuery, '<strong>$&</strong>');
                  },
                },
                source: window.debounce((query, populateResults) => {
                  tempQuery = query;
                  const searchSuggestionsPath = document.querySelector('.path_info').dataset.searchSuggestionsPath;
                  window.Utility.fetchCommoditySearchSuggestions(query, searchSuggestionsPath, [], populateResults);
                }, 200, false),
                onConfirm:(suggestion) => {
                  if (suggestion) {
                    document.querySelector('#autocomplete input').value = suggestion;
                    document.querySelector("#new_search").submit()
                  }
                }
              });

              document.querySelector('#autocomplete').onEnter = function(event) {
                document.querySelector("#new_search").submit();
              }

              window.addEventListener('pageshow', (event) => {
                event.persisted ? document.querySelector('#autocomplete input').value = '' : () => {}
               });

            }
          </script>
        </div>


        <% if @no_shared_search %>
          <%= submit_tag 'Search for a commodity', class: 'govuk-button govuk-!-margin-top-6 find-commodity-button', style: 'order: 1'  %>
        <% else %>
          <%= submit_tag 'Search', class: 'govuk-button search-button' %>
        <% end %>

        <% if @search.day_month_and_year_set? %>
          <%= hidden_field_tag :year, @search.year %>
          <%= hidden_field_tag :month, @search.month %>
          <%= hidden_field_tag :day, @search.day %>
        <% end %>
    </div>
  </div>
<% end %>
